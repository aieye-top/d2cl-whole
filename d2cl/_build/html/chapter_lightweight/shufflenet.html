<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    
    <title>3.5. ShuffleNet &#8212; Dive into cheap deep learning 0.0.1 documentation</title>

    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/d2l.css" />
    <link rel="stylesheet" href="../_static/material-design-lite-1.3.0/material.blue-deep_orange.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx_materialdesign_theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/fontawesome/all.css" type="text/css" />
    <link rel="stylesheet" href="../_static/fonts.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/d2l.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3.6. GhostNet" href="GhostNet.html" />
    <link rel="prev" title="3.4. MobileNet-v2" href="mobilenet_v2.html" /> 
  </head>
<body>
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header mdl-layout--fixed-drawer"><header class="mdl-layout__header mdl-layout__header--waterfall ">
    <div class="mdl-layout__header-row">
        
        <nav class="mdl-navigation breadcrumb">
            <a class="mdl-navigation__link" href="index.html"><span class="section-number">3. </span>Lightweight</a><i class="material-icons">navigate_next</i>
            <a class="mdl-navigation__link is-active"><span class="section-number">3.5. </span>ShuffleNet</a>
        </nav>
        <div class="mdl-layout-spacer"></div>
        <nav class="mdl-navigation">
        
<form class="form-inline pull-sm-right" action="../search.html" method="get">
      <div class="mdl-textfield mdl-js-textfield mdl-textfield--expandable mdl-textfield--floating-label mdl-textfield--align-right">
        <label id="quick-search-icon" class="mdl-button mdl-js-button mdl-button--icon"  for="waterfall-exp">
          <i class="material-icons">search</i>
        </label>
        <div class="mdl-textfield__expandable-holder">
          <input class="mdl-textfield__input" type="text" name="q"  id="waterfall-exp" placeholder="Search" />
          <input type="hidden" name="check_keywords" value="yes" />
          <input type="hidden" name="area" value="default" />
        </div>
      </div>
      <div class="mdl-tooltip" data-mdl-for="quick-search-icon">
      Quick search
      </div>
</form>
        
<a id="button-show-source"
    class="mdl-button mdl-js-button mdl-button--icon"
    href="../_sources/chapter_lightweight/shufflenet.rst.txt" rel="nofollow">
  <i class="material-icons">code</i>
</a>
<div class="mdl-tooltip" data-mdl-for="button-show-source">
Show Source
</div>
        </nav>
    </div>
    <div class="mdl-layout__header-row header-links">
      <div class="mdl-layout-spacer"></div>
      <nav class="mdl-navigation">
          
              <a  class="mdl-navigation__link" href="https://aieye-top.github.io/d2cl/d2cl.pdf">
                  <i class="fas fa-file-pdf"></i>
                  PDF
              </a>
          
              <a  class="mdl-navigation__link" href="https://github.com/aieye-top/d2cl">
                  <i class="fab fa-github"></i>
                  Github
              </a>
      </nav>
    </div>
</header><header class="mdl-layout__drawer">
    
          <!-- Title -->
      <span class="mdl-layout-title">
          <a class="title" href="../index.html">
              <span class="title-text">
                  Dive into cheap deep learning
              </span>
          </a>
      </span>
    
    
      <div class="globaltoc">
        <span class="mdl-layout-title toc">Table Of Contents</span>
        
        
            
            <nav class="mdl-navigation">
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../get_started.html">Getting Started</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../chapter_introduction/index.html">1. Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chapter_introduction/time.html">1.1. time</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_introduction/technology.html">1.2. 技术</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_introduction/privacy.html">1.3. 隐私</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_introduction/money.html">1.4. money</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_introduction/data.html">1.5. Data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chapter_write_code/index.html">2. Write code</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chapter_write_code/jupyter.html">2.1. Jupyter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_write_code/API.html">2.2. API</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">3. Lightweight</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="lightweight.html">3.1. Lightweight</a></li>
<li class="toctree-l2"><a class="reference internal" href="squeezenet.html">3.2. SqueezeNet</a></li>
<li class="toctree-l2"><a class="reference internal" href="mobilenet.html">3.3. MobileNet</a></li>
<li class="toctree-l2"><a class="reference internal" href="mobilenet_v2.html">3.4. MobileNet-v2</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">3.5. ShuffleNet</a></li>
<li class="toctree-l2"><a class="reference internal" href="GhostNet.html">3.6. GhostNet</a></li>
<li class="toctree-l2"><a class="reference internal" href="compression.html">3.7. compression</a></li>
<li class="toctree-l2"><a class="reference internal" href="pruning.html">3.8. Pruning</a></li>
<li class="toctree-l2"><a class="reference internal" href="Knowledge-Distillation.html">3.9. Knowledge-Distillation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chapter_train/index.html">4. Train</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chapter_train/Server.html">4.1. Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_train/Active_Learning.html">4.2. Active Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_train/pretrain.html">4.3. Pretrain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_train/improve.html">4.4. 改进</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_train/structure.html">4.5. 结构</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chapter_deploy/index.html">5. Deployment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chapter_deploy/hardware.html">5.1. 芯片</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_deploy/edge.html">5.2. Edge</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_deploy/mobile.html">5.3. mobile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_deploy/MCU.html">5.4. MCU</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_deploy/AI-zhongtai.html">5.5. AI 中台</a></li>
</ul>
</li>
</ul>

            </nav>
        
        </div>
    
</header>
        <main class="mdl-layout__content" tabIndex="0">

	<script type="text/javascript" src="../_static/sphinx_materialdesign_theme.js "></script>
    <header class="mdl-layout__drawer">
    
          <!-- Title -->
      <span class="mdl-layout-title">
          <a class="title" href="../index.html">
              <span class="title-text">
                  Dive into cheap deep learning
              </span>
          </a>
      </span>
    
    
      <div class="globaltoc">
        <span class="mdl-layout-title toc">Table Of Contents</span>
        
        
            
            <nav class="mdl-navigation">
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../get_started.html">Getting Started</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../chapter_introduction/index.html">1. Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chapter_introduction/time.html">1.1. time</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_introduction/technology.html">1.2. 技术</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_introduction/privacy.html">1.3. 隐私</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_introduction/money.html">1.4. money</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_introduction/data.html">1.5. Data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chapter_write_code/index.html">2. Write code</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chapter_write_code/jupyter.html">2.1. Jupyter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_write_code/API.html">2.2. API</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">3. Lightweight</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="lightweight.html">3.1. Lightweight</a></li>
<li class="toctree-l2"><a class="reference internal" href="squeezenet.html">3.2. SqueezeNet</a></li>
<li class="toctree-l2"><a class="reference internal" href="mobilenet.html">3.3. MobileNet</a></li>
<li class="toctree-l2"><a class="reference internal" href="mobilenet_v2.html">3.4. MobileNet-v2</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">3.5. ShuffleNet</a></li>
<li class="toctree-l2"><a class="reference internal" href="GhostNet.html">3.6. GhostNet</a></li>
<li class="toctree-l2"><a class="reference internal" href="compression.html">3.7. compression</a></li>
<li class="toctree-l2"><a class="reference internal" href="pruning.html">3.8. Pruning</a></li>
<li class="toctree-l2"><a class="reference internal" href="Knowledge-Distillation.html">3.9. Knowledge-Distillation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chapter_train/index.html">4. Train</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chapter_train/Server.html">4.1. Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_train/Active_Learning.html">4.2. Active Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_train/pretrain.html">4.3. Pretrain</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_train/improve.html">4.4. 改进</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_train/structure.html">4.5. 结构</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../chapter_deploy/index.html">5. Deployment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../chapter_deploy/hardware.html">5.1. 芯片</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_deploy/edge.html">5.2. Edge</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_deploy/mobile.html">5.3. mobile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_deploy/MCU.html">5.4. MCU</a></li>
<li class="toctree-l2"><a class="reference internal" href="../chapter_deploy/AI-zhongtai.html">5.5. AI 中台</a></li>
</ul>
</li>
</ul>

            </nav>
        
        </div>
    
</header>

    <div class="document">
        <div class="page-content" role="main">
        
  <div class="section" id="shufflenet">
<h1><span class="section-number">3.5. </span>ShuffleNet<a class="headerlink" href="#shufflenet" title="Permalink to this headline">¶</a></h1>
<p>网络是Megvii Inc. (Face++)提出。ShuffleNet pursues the best accuracy in
very limited computational budgets at tens or hundreds of MFLOPs In ARM
device, ShuffleNet achieves 13× actual speedup over AlexNet while
maintaining comparable accuracy.[6] 2018 CVPR : 300 citations.</p>
<p>Experiments on ImageNet classification and MS COCO object detection
demonstrate the superior performance of ShuffleNet over other
structures, e.g. lower top-1 error (absolute 7.8%) than recent MobileNet
on ImageNet classification task, under the computation budget of 40
MFLOPs.[2]</p>
<p>CNN 分组卷积 ResNet</p>
<p>分组点卷积 通道重排 shufflenet v2 pytorch复现</p>
<div class="section" id="id1">
<h2><span class="section-number">3.5.1. </span>动机<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>数百层和数千通道，Billions of FLOPs</p>
</div>
<div class="section" id="id2">
<h2><span class="section-number">3.5.2. </span>方法<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>属于直接训练而不是压缩</p>
</div>
<div class="section" id="group-convolutions">
<h2><span class="section-number">3.5.3. </span>分组点卷积Group convolutions`<a class="headerlink" href="#group-convolutions" title="Permalink to this headline">¶</a></h2>
<p>给点卷积也分组</p>
<p>分组点卷积某个通道的输出仅来及一部分输入通道，阻止了信息流动，特征表示。</p>
<p>Group convolutions are used in AlexNet and ResNeXt. (a): There is no
channel shuffle, each output channel only relates to the input channels
within the group. This property blocks information flow between channel
groups and weakens representation. (b): If we allow group convolution to
obtain input data from different groups, the input and output channels
will be fully related. (c): The operations in (b) can be efficiently and
elegantly implemented by a channel shuffle operation. Suppose a
convolutional layer with g groups whose output has g×n channels; we
first reshape the output channel dimension into (g, n), transposing and
then flattening it back as the input of next layer. And channel shuffle
is also differentiable, which means it can be embedded into network
structures for end-to-end training.[6]</p>
</div>
<div class="section" id="channel-shuffle">
<h2><span class="section-number">3.5.4. </span>通道重排(channel shuffle)<a class="headerlink" href="#channel-shuffle" title="Permalink to this headline">¶</a></h2>
<p>如果我们允许组卷积从不同组中获取输入数据，则输入和输出通道讲完全相关。</p>
<p>对于从上一个组层生成的特征图，可以先将每一个组中的通道划分为几个子组，
然后在下一层中的每个组中使用不同的子组作为输入。</p>
<p>ShuffleNet中的Channel
Shuffle操作可以将组间的信息进行交换，并且可以实现端到端的训练。</p>
<p>Group
convolution。其中输入特征通道被为G组(图4)，并且对于每个分组的信道独立地执行卷积，则分组卷积计算量是HWNK²M/G，为标准卷积计算量的1/G。
Channel shuffle。Grouped
Convlution导致模型的信息流限制在各个group内，组与组之间没有信息交换，这会影响模型的表示能力。因此，需要引入group之间信息交换的机制，即Channel
Shuffle操作。</p>
<p>引入的问题：[5]</p>
<p>channel shuffle在工程实现占用大量内存和指针跳转，这部分很耗时。 channel
shuffle的规则是人工设计，分组之间信息交流存在随意性，没有理论指导。</p>
<p>The motivation of ShuffleNet is the fact that conv1x1 is the bottleneck
of separable conv as mentioned above. While conv1x1 is already efficient
and there seems to be no room for improvement, grouped conv1x1 can be
used for this purpose!</p>
<p>The above figure illustrates the module for ShuffleNet. The important
building block here is the channel shuffle layer which “shuffles” the
order of the channels among groups in grouped convolution. Without
channel shuffle, the outputs of grouped convolutions are never exploited
among groups, resulting in the degradation of accuracy.[7]</p>
</div>
<div class="section" id="flops">
<h2><span class="section-number">3.5.5. </span>FLOPS<a class="headerlink" href="#flops" title="Permalink to this headline">¶</a></h2>
<p><img alt="FLOPs" src="chapter_lightweight/#flops" /> (../img/Shuffle_Flops.jpg)</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>


<span class="k">class</span> <span class="nc">ShuffleBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groups</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ShuffleBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Channel shuffle: [N,C,H,W] -&gt; [N,g,C/g,H,W] -&gt; [N,C/g,g,H,w] -&gt; [N,C,H,W]&#39;&#39;&#39;</span>
        <span class="n">N</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">W</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">C</span><span class="o">//</span><span class="n">g</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">W</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">W</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Bottleneck</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_planes</span><span class="p">,</span> <span class="n">out_planes</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">groups</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Bottleneck</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">stride</span>

        <span class="n">mid_planes</span> <span class="o">=</span> <span class="n">out_planes</span><span class="o">/</span><span class="mi">4</span>
        <span class="n">g</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">in_planes</span><span class="o">==</span><span class="mi">24</span> <span class="k">else</span> <span class="n">groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_planes</span><span class="p">,</span> <span class="n">mid_planes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">mid_planes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle1</span> <span class="o">=</span> <span class="n">ShuffleBlock</span><span class="p">(</span><span class="n">groups</span><span class="o">=</span><span class="n">g</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">mid_planes</span><span class="p">,</span> <span class="n">mid_planes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">mid_planes</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bn2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">mid_planes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">mid_planes</span><span class="p">,</span> <span class="n">out_planes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bn3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_planes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shortcut</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">stride</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shortcut</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">AvgPool2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bn1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle1</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bn2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">out</span><span class="p">)))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortcut</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">out</span><span class="p">,</span><span class="n">res</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="o">==</span><span class="mi">2</span> <span class="k">else</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">out</span><span class="o">+</span><span class="n">res</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">ShuffleNetG2</span><span class="p">():</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;out_planes&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span><span class="mi">400</span><span class="p">,</span><span class="mi">800</span><span class="p">],</span>
        <span class="s1">&#39;num_blocks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>
        <span class="s1">&#39;groups&#39;</span><span class="p">:</span> <span class="mi">2</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ShuffleNet</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ShuffleNetG3</span><span class="p">():</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;out_planes&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">240</span><span class="p">,</span><span class="mi">480</span><span class="p">,</span><span class="mi">960</span><span class="p">],</span>
        <span class="s1">&#39;num_blocks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span>
        <span class="s1">&#39;groups&#39;</span><span class="p">:</span> <span class="mi">3</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ShuffleNet</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="n">net</span> <span class="o">=</span> <span class="n">ShuffleNetG2</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The proposed network is mainly composed of a stack of ShuffleNet
units grouped into three stages.</p></li>
<li><p>The number of bottleneck channels is set to 1/4 of the output
channels for each ShuffleNet unit.</p></li>
<li><p>A scale factor s is applied on the number of channels. The networks
in the above table is denoted as “ShuffleNet 1×”, then ”ShuffleNet
s×” means scaling the number of filters in ShuffleNet 1× by s times
thus overall complexity will be roughly s² times of ShuffleNet 1×.</p></li>
</ul>
<p>ShuffleNet也从宏观和微观两个层面分别对网络进行了优化。无独有偶，其瞄准的主要优化对象其实也是卷积核，ShuffleNet不仅采用了更小的卷积核，而且还采用了一种分组卷积的概念组合小型的卷积核，以求减少计算的复杂度。</p>
<p>ShuffleNet和ResNet结构可知，ShuffleNet计算量降低主要是通过分组卷积实现。ShuffleNet虽然降低了计算量，但是引入两个新的问题：<a class="reference external" href="https://zhuanlan.zhihu.com/p/45496826">4</a></p>
<p>1、channel shuffle在工程实现占用大量内存和指针跳转，这部分很耗时。
2、channel
shuffle的规则是人工设计，分组之间信息交流存在随意性，没有理论指导。</p>
</div>
<div class="section" id="id3">
<h2><span class="section-number">3.5.6. </span>什么是分组<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>所谓分组就是将输入与输出的通道分成几组，比如输出与输入的通道数都是4个且分成2组，那第1、2通道的输出只使用第1、2通道的输入，同样第3、4通道的输出只使用第3、4通道的输入。也就是说不同组之间的输入和输出之间完全没有了关系，减少联系势必减少计算量（有联系就说明要进行运算）。当然这种方式的副作用就是会损失信息，可能导致准确率下降</p>
<div class="section" id="id4">
<h3><span class="section-number">3.5.6.1. </span>计算量可减少多少<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>在分组之前，每一层的参数数量是 <span class="math notranslate nohighlight">\(N \times C \times H \times W\)</span>,
如果将输入输出分成 <span class="math notranslate nohighlight">\(g\)</span> 组，那么每一组的参数数量就会变成
<span class="math notranslate nohighlight">\(\frac{N \times C \times H \times W}{g}\)</span>
个，虽然每层特征输出总数量
依然不变，但是每一组自己运算的计算次数也会变成原来的
<span class="math notranslate nohighlight">\(\frac{1}{g},\)</span> 也就是说分组之后计算量可以降低到 原来的
<span class="math notranslate nohighlight">\(\frac{1}{g^{2}},\)</span> 而参数数量可以降低到原来的 <span class="math notranslate nohighlight">\(\frac{1}{g}\)</span>
。</p>
<p>以上是单样本输入的情况，那么如果同时输入多个样本呢？
如果是在内存资源充足的服务器端，我们 可以利用数据并行的思路,
让k个样本多线程同时执行，速度自然可以提高K倍。但是在移动平台我
们往往没有那么充足的内存资源, CPU也不支持太多线程同时执行,
因此很有可能每个样本依然是独 立执行的，速度变化和单样本没有什么差距。</p>
<p>不过这些都是理论分析，实际上移动平台的计算效率并不能提高如此之多，一方面卷积运算一般为了减少预算复杂度，都是先通过im2col转成向量，然后执行矩阵乘法，而im2col和矩阵运算时间其实相差无几，同时现代化的线性代数库都极大优化了矩阵运算性能，因此实际的性能提升肯定会受到影响。</p>
</div>
</div>
<div class="section" id="shufflenet-v28">
<h2><span class="section-number">3.5.7. </span>ShuffleNet-V2<a class="reference external" href="https://github.com/megvii-model/ShuffleNet-Series">8</a><a class="headerlink" href="#shufflenet-v28" title="Permalink to this headline">¶</a></h2>
<p>由上图可以看到，相同FLOPs的两个模型,
各部分的运行时间存在着明显的差异。这种不一致主要归结为两个原因: 1)
影响速度的不仅仅是FLOPs，还有内存访问成本（Memory Access cost, MAC） ;
2）模型的并行</p>
<p>程度也会影响速度,
并行度高的模型速度相对更快。因此作者结合理论与实践得到了四条实用的设计原则。
1. 同等通道大小最小化内存访问成本一一使用1 <span class="math notranslate nohighlight">\(\times 1\)</span>
卷积平衡输入和输出的通道大小 2.
过量使用分组卷积会增加MAC一一分组卷积要谨慎实用, 注意分组数 3.
网络碎片化会降低并行度, 一些网络如inception等倾向于采用“多路”结构,
既存在一个block中有很多不同 的小卷积或pooling，这容易造成网络碎片化,
降低并行度。一文避免网络碎片化 4.
不能忽略元素级别的操作，例如ReLU和Add等操作，这些操作虽然FLOPs较小，但是MAC较大。——减少元素级运算</p>
<p>(a): the basic ShuffleNet-V1 unit; (b) the ShuffleNet-V1 unit for
spatial down sampling <span class="math notranslate nohighlight">\((2 \times) ;\)</span> (c) ShuffleNet-V2 basic unit;
(d) ShuffleNet-V2 unit for spatial down sampling ( <span class="math notranslate nohighlight">\(2 \times\)</span> )</p>
<p>ShuffleNet-V2 相对与V1，引入了一种新的运算: channel
split。具体来说，在开始时先将输入特征图在通道
维度分成两个分支：通道数分别为 <span class="math notranslate nohighlight">\(C^{\prime}\)</span> 和
<span class="math notranslate nohighlight">\(C-C^{\prime},\)</span> 实际实现时 <span class="math notranslate nohighlight">\(C^{\prime}=C / 2\)</span>
。左边分支做同等映射, 右边的 分支包含3个连续的卷积,
并且输入和输出通道相同，这符合准则1。而且两个1x1卷积不再是组卷积, 这符合
准则2，另外两个分支相当于已经分成两组。两个分支的输出不再是Add元素，而是concat在一起,
紧接着是 对两个分支concat结果进行channle shuffle,
以保证两个分支信息交流。其实concat和channel shuffle可以和
下一个模块单元的channel
split合成一个元素级运算，这符合准则4。整体网络结果如下表:</p>
</div>
<div class="section" id="comparison-with-mobilenetv16">
<h2><span class="section-number">3.5.8. </span>Comparison with MobileNetV1<a class="reference external" href="https://towardsdatascience.com/review-shufflenet-v1-light-weight-model-image-classification-5b253dfe982f">6</a><a class="headerlink" href="#comparison-with-mobilenetv16" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>ShuffleNet models are superior to MobileNetV1 for all the
complexities.</p></li>
<li><p>Though ShuffleNet network is specially designed for small models (&lt;
150 MFLOPs), it is still better than MobileNetV1 for higher
computation cost, e.g. 3.1% more accurate than MobileNetV1 at the
cost of 500 MFLOPs.</p></li>
<li><p>The simple architecture design also makes it easy to equip ShuffeNets
with the latest advances such as Squeeze-and-Excitation (SE) blocks.
(Hope I can review SENet in the future.)</p></li>
<li><p>ShuffleNets with SE modules boosting the top-1 error of ShuffleNet 2×
to 24.7%, but are usually 25 to 40% slower than the “raw” ShuffleNets
on mobile devices, which implies that actual speedup evaluation is
critical on low-cost architecture design.</p></li>
</ul>
<p>它在移动端低功耗设备提出了一种更为高效的卷积模型结构，在大幅降低模型计算复杂度的同时仍然保持了较高的识别精度，并在多个性能指标上均显著超过了同类方法。<a class="reference external" href="http://os.aiiaorg.cn/open/article/1201782277957726210">9</a>
　　ShuffleNet Series涵盖以下6个模型： 　　（1） ShuffleNetV1:
ShuffleNet: An Extremely Efficient Convolutional Neural Network for
Mobile Devices 　　论文链接：<a class="reference external" href="https://arxiv.org/abs/1707.01083">https://arxiv.org/abs/1707.01083</a>
　　解读链接：为移动 AI 而生——旷视最新成果 ShuffleNet 全面解读 　　（2）
ShuffleNetV2: ShuffleNet V2: Practical Guidelines for Efficient CNN
Architecture Design 　　论文链接：<a class="reference external" href="https://arxiv.org/abs/1807.11164">https://arxiv.org/abs/1807.11164</a>
　　解读链接：ECCV 2018 | 旷视提出新型轻量架构ShuffleNet
V2：从理论复杂度到实用设计准则 　　（3） ShuffleNetV2+: ShuffleNetV2
的增强版 　　（4） ShuffleNetV2.Large: ShuffleNetV2 的深化版 　　（5）
OneShot: Single Path One-Shot Neural Architecture Search with Uniform
Sampling 　　论文链接：<a class="reference external" href="https://arxiv.org/abs/1904.00420">https://arxiv.org/abs/1904.00420</a>
　　解读链接：AutoML | 旷视研究院提出One-Shot模型搜索框架的新变体
　　（6） DetNAS: DetNAS: Backbone Search for Object Detection
　　论文链接：<a class="reference external" href="https://arxiv.org/abs/1903.10979">https://arxiv.org/abs/1903.10979</a></p>
</div>
</div>


        </div>
        <div class="side-doc-outline">
            <div class="side-doc-outline--content"> 
<div class="localtoc">
    <p class="caption">
      <span class="caption-text">Table Of Contents</span>
    </p>
    <ul>
<li><a class="reference internal" href="#">3.5. ShuffleNet</a><ul>
<li><a class="reference internal" href="#id1">3.5.1. 动机</a></li>
<li><a class="reference internal" href="#id2">3.5.2. 方法</a></li>
<li><a class="reference internal" href="#group-convolutions">3.5.3. 分组点卷积Group convolutions`</a></li>
<li><a class="reference internal" href="#channel-shuffle">3.5.4. 通道重排(channel shuffle)</a></li>
<li><a class="reference internal" href="#flops">3.5.5. FLOPS</a></li>
<li><a class="reference internal" href="#id3">3.5.6. 什么是分组</a><ul>
<li><a class="reference internal" href="#id4">3.5.6.1. 计算量可减少多少</a></li>
</ul>
</li>
<li><a class="reference internal" href="#shufflenet-v28">3.5.7. ShuffleNet-V28</a></li>
<li><a class="reference internal" href="#comparison-with-mobilenetv16">3.5.8. Comparison with MobileNetV16</a></li>
</ul>
</li>
</ul>

</div>
            </div>
        </div>

      <div class="clearer"></div>
    </div><div class="pagenation">
     <a id="button-prev" href="mobilenet_v2.html" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored" role="botton" accesskey="P">
         <i class="pagenation-arrow-L fas fa-arrow-left fa-lg"></i>
         <div class="pagenation-text">
            <span class="pagenation-direction">Previous</span>
            <div>3.4. MobileNet-v2</div>
         </div>
     </a>
     <a id="button-next" href="GhostNet.html" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--colored" role="botton" accesskey="N">
         <i class="pagenation-arrow-R fas fa-arrow-right fa-lg"></i>
        <div class="pagenation-text">
            <span class="pagenation-direction">Next</span>
            <div>3.6. GhostNet</div>
        </div>
     </a>
  </div>
        
        </main>
    </div>
  </body>
</html>